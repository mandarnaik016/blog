---
layout: post
title: Malware Analysis - VIP Keylogger - Part 2
subtitle: The Fun Continues
cover-img: /assets/img/analysis/analysis.jpeg
thumbnail-img: ""
tags: [analysis, security]
---

Hello, Let's continue with the analysis of VIP keylogger.

From the first part of malware analysis, we ended up with two executables.

We will call them *orange_part1.exe.vir* that has an actual name being *tzeyswvngw.tmp* and *orange_part2.exe.vir* that has an actual name being *aaotaboryx.tmp*

The file *orange_part1.exe.vir* has an SHA256 hash of,
```
0cae791ae86fd4960e6f9d62aac7941b1eee669e8ae373b28b32fba45e4bf46e
```

The file is present on Virustotal and is being detected by 8 AV.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/virustotal-result-of-tzeyswvngw.tmp.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/virustotal-result-of-tzeyswvngw.tmp.png" img_caption="Figure 1: Virustotal result of tzeyswvngw.tmp" img_alt="Virustotal result of tzeyswvngw.tmp" %}

The file is written in the .NET language, as shown by DIE.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/die-of-orange_part1.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/die-of-orange_part1.exe.vir.png" img_caption="Figure 2: DIE of orange_part1.exe.vir" img_alt="DIE of orange_part1.exe.vir" %}

We can use dnSpy to view the decompiled source code.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/decompiled-source-code-of-orange_part1.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/decompiled-source-code-of-orange_part1.exe.vir.png" img_caption="Figure 3: Decompiled source code of orange_part1.exe.vir" img_alt="Decompiled source code of orange_part1.exe.vir" %}

The main function is empty. We assume this is a dummy file that does nothing when executed.

Let's start with the analysis of the second file,

The second file *orange_part2.exe.vir* has an SHA256 hash of,
```
ca9e6eb1c8f2be20eaf9c220cf8482c264edd9c42389fc391eeed41dfe8de59b
```

The file is present on Virustotal and is being detected by 50 AV.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/virustotal-result-of-aaotaboryx.tmp.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/virustotal-result-of-aaotaboryx.tmp.png" img_caption="Figure 4: Virustotal result of aaotaboryx.tmp" img_alt="Virustotal result of aaotaboryx.tmp" %}

This file is also written in the .NET language, as shown by DIE
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/die-of-orange_part2.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/die-of-orange_part2.exe.vir.png" img_caption="Figure 5: DIE of orange_part2.exe.vir" img_alt="DIE of orange_part2.exe.vir" %}

The file *orange_part2.exe.vir* contains suspicious functions like VirtualProtect, CreateDecryptor, etc.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/suspicious-flags.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/suspicious-flags.png" img_caption="Figure 6: Suspicious flags" img_alt="Suspicious flags" %}

The strings within do provide insightful data,
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/strings-within-orange_part2.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/strings-within-orange_part2.exe.vir.png" img_caption="Figure 7: Strings within orange_part2.exe.vir" img_alt="Strings within orange_part2.exe.vir" %}

Strings insight (From fig. 7):
1. Checks some values and extensions for condition matching.
2. Base64 encoded strings for data obfuscation.
3. Sets exclusions for itself in Microsoft Defender to evade detection.

To identify further capabilities, we use Capa,
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/capabilities-of-orange_part2.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/capabilities-of-orange_part2.exe.vir.png" img_caption="Figure 8: Capabilities of orange_part2.exe.vir" img_alt="Capabilities of orange_part2.exe.vir" %}

We load the sample in dnSpy and locate the main function to understand the behavior and execution flow.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/initial-code-of-orange_part2.exe.vir.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/initial-code-of-orange_part2.exe.vir.png" img_caption="Figure 9: Initial code of orange_part2.exe.vir" img_alt="Initial code of orange_part2.exe.vir" %}

Code Insight (From fig. 9):
1. The application executes with a **hidden window**. This is one of the capabilities we identified using Capa, being listed as "hide graphical window".
2. The "ntdll.dll" is loaded, and the "EtwEventWrite" function is used to turn off telemetry. It would be categorized as "patch Event Tracing for Windows function".
3. From fig. 6, VirtualProtect is being used to make the memory location read-write.
4. At last, the variable *text* of type string is being initialized.

The string text and its content are being passed through a series of operations, and the output is stored in the variable **array4**.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/deobfuscated-data-in-variable-array4.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/deobfuscated-data-in-variable-array4.png" img_caption="Figure 10: Deobfuscated data in variable array4" img_alt="Deobfuscated data in variable array4" %}

The function *tftdhjpyudniswzlxstwqwgic* returns the contents of the file *xxxx*.exe* from the manifest resources.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/function-to-load-content-of-file-xxxx.exe.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/function-to-load-content-of-file-xxxx.exe.png" img_caption="Figure 11: Function to load content of file xxxx.exe" img_alt="Function to load content of file xxxx.exe" %}

There exists a file named *xxxx*.exe* in the resource section, and it is not executable.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/file-in-resources-section.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/file-in-resources-section.png" img_caption="Figure 12: File in resources section" img_alt="File in resources section" %}
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/die-of-xxxx.exe.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/die-of-xxxx.exe.png" img_caption="Figure 13: DIE of xxxx.exe" img_alt="DIE of xxxx.exe" %}

The function *ybuqbwzamyefzwijdqsenomvw* returns the AES decrypted data of the content of "xxxx*.exe" with the keys and IV mentioned in the base64 encoded format.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/function-to-decrypt-content.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/function-to-decrypt-content.png" img_caption="Figure 14: Function to decrypt content" img_alt="Function to decrypt content" %}

At last, the function *yjrhqztigcmthjjbmoycwxuai* does the gzip decompression on the returned AES decrypted data.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/function-to-decompress-content.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/function-to-decompress-content.png" img_caption="Figure 15: Function to decompress content" img_alt="Function to decompress content" %}

To get the content of the variable array4, we debug the application,
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/code-debugging.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/code-debugging.png" img_caption="Figure 16: Code debugging" img_alt="Code debugging" %}

The data stored in the memory location can be viewed. The magic byte **MZ** and **this program cannot be run in DOS mode** in the memory indicate that it is an executable file.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/content-of-memory.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/content-of-memory.png" img_caption="Figure 17: Content of memory" img_alt="Content of memory" %}

The same set of operations, i.e., Get the content of a file, AES decryption, and GZIP decompression in CyberChef, also yields the same executable file.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/operation-using-cyberchef.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/operation-using-cyberchef.png" img_caption="Figure 18: Operation using cyberchef" img_alt="Operation using cyberchef" %}

We dump the file from memory for further analysis,

The dumped file *array4.dump* is also written in .NET language, as shown by DIE.
{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger2/lowly/die-of-dumped-data.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger2/die-of-dumped-data.png" img_caption="Figure 19: DIE of dumped data" img_alt="DIE of dumped data" %}
