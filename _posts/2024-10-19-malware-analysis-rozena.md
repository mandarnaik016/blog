---
layout: post
title: Malware Analysis - Rozena
subtitle: You Trust Me? Right
cover-img: /assets/img/analysis/analysis.webp
thumbnail-img: ""
tags: [analysis, security]
---

In this post, we will analyze and reverse-engineer a sample called **Rozena**

We downloaded the sample from [Malware Bazaar](https://bazaar.abuse.ch/sample/94200b3b4792c019ebe7bcfd16573fdedf385369e41309d82958568078e90c43/)

The sample is an *MSI file* masquerading as a **Chrome Installer**.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-file-initial.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-file-initial.png" img_alt="msi file initial" %}

Let us calculate the hash of the sample using a hasher.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-file-hash.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-file-hash.png" img_alt="msi file hash" %}

We can use VirusTotal to get the initial insight.

The sample has been flagged by 9 engines.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-file-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-file-vt.png" img_alt="msi file vt" %}

Since the sample is an MSI file, We can use *7zip* to check the content of the sample.

The MSI file contains the following.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-file-content.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-file-content.png" img_alt="msi file content" %}

Let us extract this content in a folder.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-file-content-extracted.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-file-content-extracted.png" img_alt="msi file content extracted" %}

We now have **3 PE** files along with one file of unknown format, Let us use _hasher_ to get the hashes of all the files.

The *ChromeSetup_1_.exe* seems legitimate,

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/chrome-hash.jpeg" img_datasrc="../assets/img/analysis/rozena/chrome-hash.png" img_alt="chrome hash" %}

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/chrome-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/chrome-vt.png" img_alt="chrome vt" %}

The next file is also reported as clean but an important thing to note is that the file is an *.7z* archive.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/archive-hash.jpeg" img_datasrc="../assets/img/analysis/rozena/archive-hash.png" img_alt="archive hash" %}

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/archive-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/archive-vt.png" img_alt="archive vt" %}

To further verify this use DIE,

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/archive-die.jpeg" img_datasrc="../assets/img/analysis/rozena/archive-die.png" img_alt="archive die" %}

Let us change the extension of the file to *.7z*, the file is protected with the password, we need to investigate further.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/archive-password-protected.jpeg" img_datasrc="../assets/img/analysis/rozena/archive-password-protected.png" img_alt="archive password protected" %}

The next file is a *7zr.exe* which may be used to extract the previous file.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/7zr-hash.jpeg" img_datasrc="../assets/img/analysis/rozena/7zr-hash.png" img_alt="7zr hash" %}

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/7zr-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/7zr-vt.png" img_alt="7zr vt" %}

The last file has also been reported as clean by VirusTotal.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/uninstall-hash.jpeg" img_datasrc="../assets/img/analysis/rozena/uninstall-hash.png" img_alt="uninstall hash" %}

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/uninstall-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/uninstall-vt.png" img_alt="uninstall vt" %}

 The *DIE* shows the file as a *Nullsoft Scriptable Installer* but as no antivirus flagged it as malicious we can skip this. 

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/uninstall-die.jpeg" img_datasrc="../assets/img/analysis/rozena/uninstall-die.png" img_alt="uninstall die" %}

In the current scenario out of 4 files, 2 of them are legitimate while the other two that is the *.7z archive* and the *7zr.exe* can be held for further investigation.

When we check the file properties it is named *Improve Defender silent installer*, we can utilize this data while dynamic analysis.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-properties.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-properties.png" img_alt="msi properties" %}

Instead of 7zip, we can use the following command to extract the content of the MSI file along with build instructions and any other binary data.

~~~
msiexec /a rozena.msi /qb TARGETDIR=c:\temp\test
~~~

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/extract-build-data-from-msi.jpeg" img_datasrc="../assets/img/analysis/rozena/extract-build-data-from-msi.png" img_alt="extract build data from msi" %}

After extraction in the binary data, we can see the path to which the content of the MSI file will be extracted, also the password for decryption for the .7z archive can be found.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/binary-main-password.jpeg" img_datasrc="../assets/img/analysis/rozena/binary-main-password.png" img_alt="binary main password" %}

Further wandering in the file we can see a command line that extracts the content using the mentioned password.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/binary-main-extraction.jpeg" img_datasrc="../assets/img/analysis/rozena/binary-main-extraction.png" img_alt="binary main extraction" %}

We can use this password to verify the content of the encrypted archive. The encrypted archive has 3 files let us extract them in a folder

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/archive-content.jpeg" img_datasrc="../assets/img/analysis/rozena/archive-content.png" img_alt="archive content" %}

The first file extracted is Windows Service wrapper while the second PE file seems Torjan Rozena, we can search the hash of the file on VirusTotal.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/rozena-vt.jpeg" img_datasrc="../assets/img/analysis/rozena/rozena-vt.png" img_alt="rozena vt" %}

In the binary data, there is a function to add MSI file extraction path in exclusion of Microsoft Defender which has been used for *AV Evasion*.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/binary-main-exclusion.jpeg" img_datasrc="../assets/img/analysis/rozena/binary-main-exclusion.png" img_alt="binary main exclusion" %}

That starts with dynamic analysis.

We use *Procmon* to get the activity performed after execution.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/procmon-improve.jpeg" img_datasrc="../assets/img/analysis/rozena/procmon-improve.png" img_alt="procmon improve" %}

We can see the PE files in the encrypted archive are performing various actions.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/procmon-capture.jpeg" img_datasrc="../assets/img/analysis/rozena/procmon-capture.png" img_alt="procmon capture" %}

We can get the process tree using Process Explorer it seems the Windows Service wrapper spawned Torjon as a sub-process.

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/process-explorer-tree.jpeg" img_datasrc="../assets/img/analysis/rozena/process-explorer-tree.png" img_alt="process explorer tree" %}

Let us verify the extraction of the MSI file in the program files path. 

{% include lazyimg.html img_src="../assets/img/analysis/rozena/lowly/msi-folder-content.jpeg" img_datasrc="../assets/img/analysis/rozena/msi-folder-content.png" img_alt="msi folder content" %}

We get clarity on the Chrome setup.exe and uninstall.exe which are already present in the MSI file. The *7zr.exe* and the *archive* got deleted but the content inside the archive resides along with them.
 
### IOCs

1. Hashes
	~~~
	94200b3b4792c019ebe7bcfd16573fdedf385369e41309d82958568078e90c43
	c7101b019dc7625c4036420b8c9f90ad4c6e7e57d847b1c60c6270cc67cf8aca
	ca4003d03ebc1265e961fc2463df76bcd58c93a1be12f62ed58af4e0930df7ae
	e2dde008486ee007b634bb8012ae1fc11f79ee4a2ce6e4d5337074cfb2582e73
	~~~