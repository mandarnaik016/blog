---
layout: post
title: Malware Analysis - Lumma Stealer
subtitle: Are You A Robot?
cover-img: /assets/img/analysis/analysis.webp
thumbnail-img: ""
tags: [analysis, security]
---
In this post, we will analyze malware and reverse engineer a sample called **lumma stealer**.

A web-based attack vector has a captcha page that asks the users to perform the task for verification.

The user is presented with a captcha page as shown below,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malicious-webpage.jpeg" img_datasrc="../assets/img/analysis/lumma/malicious-webpage.png" img_alt="malicious webpage" %}

On a legitimate page, the user will be asked to select some boxes that contain this or that object, but here the users are asked to run a PowerShell script for verification that is **automatically copied to the system clipboard** once the user clicks on "I am not a robot" as shown below,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malicious-webpage-action.jpeg" img_datasrc="../assets/img/analysis/lumma/malicious-webpage-action.png" img_alt="malicious webpage action" %}

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/powershell-execution-from-malicious-page.jpeg" img_datasrc="../assets/img/analysis/lumma/powershell-execution-from-malicious-page.png" img_alt="powershell execution from malicious page" %}

We will use the automatically copied PowerShell script for investigation, the script contains a base64 encoded text being executed with a hidden window.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/automatically-copied-powershell-script.jpeg" img_datasrc="../assets/img/analysis/lumma/automatically-copied-powershell-script.png" img_alt="automatically copied powershell script" %}

After decoding the base64 text we get the following data, The decoded text contains another PowerShell command to execute the content of a file called _a.txt_ stored at a remote location.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/base64-decoded-powershell-script.jpeg" img_datasrc="../assets/img/analysis/lumma/base64-decoded-powershell-script.png" img_alt="base64 decoded powershell script" %}

We download the _a.txt_ file for further examination.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/a-txt-file-downloaded.jpeg" img_datasrc="../assets/img/analysis/lumma/a-txt-file-downloaded.png" img_alt="a.txt file downloaded" %}

The _a.txt_ contains,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/a-txt-file-content.jpeg" img_datasrc="../assets/img/analysis/lumma/a-txt-file-content.png" img_alt="a.txt file content" %}

The file in turn contains another PowerShell command that downloads the file called _malt.zip_ from a remote location and stores that file with a different name _pg1.zip_ in a temp location, it then extracts the _pg1.zip_ content into the folder called _file_ then executes the _set-up.exe_ from that path.

After unzipping _malt.zip_ the directory content is,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malt-zip-file-content.jpeg" img_datasrc="../assets/img/analysis/lumma/malt-zip-file-content.png" img_alt="malt.zip file content" %}

The interesting thing to note, the file _set-up.exe_ has a resemblance to the **Iobit uninstaller**. A normal user would see the copyright of the file to be Iobit and might consider the file as Legitimate.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/properties-of-setup-exe-iobit.jpeg" img_datasrc="../assets/img/analysis/lumma/properties-of-setup-exe-iobit.png" img_alt="properties of set-up.exe iobit" %}

Apart from _set-up.exe_, we do not find any executable in the directory but after we check the file type of every file we can see that most of the files with _.bpl_ extension are executable.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/file-type-of-unzipped-malt-zip.jpeg" img_datasrc="../assets/img/analysis/lumma/file-type-of-unzipped-malt-zip.png" img_alt="file type of unzipped malt.zip" %}

We ran floss on *madbasic_.bpl*, *maddisAsm_.bpl*, *madexcept_.bpl* and *Set-up.exe*,

The strings inside *madbasic_.bpl* seems pretty interesting they include text like Encrypt, Decrypt, Encode, and Decode.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/madbasic_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/madbasic_.bpl-floss.png" img_alt="madbasic_.bpl floss" %}

The file *maddisAsm_.bpl* has a reference to the previous file *madbasic_.bpl*.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/maddisAsm_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/maddisAsm_.bpl-floss.png" img_alt="maddisAsm_.bpl floss" %}

The file *madexcept_.bpl* contains text like HTTP account, password, SMTP account, password, etc.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/madexcept_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/madexcept_.bpl-floss.png" img_alt="madexcept_.bpl floss" %}

At last, the _Set-up.exe_ contains text like sending mail, sending attachments, etc.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/set-up.exe-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/set-up.exe-floss.png" img_alt="set-up.exe floss" %}

Let's do a dynamic analysis to get more insight.

After we execute the file we use **procom** to get the activity performed by _Set-up.exe_ file.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/process-monitor-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/process-monitor-setup-exe.png" img_alt="process monitor set-up.exe" %}

The file did perform a lot of activity but the most interesting are **CreateFile**, **WriteFile**, and **CreateProcess**.

The process tree gave us more insight i.e. the _Set-up.exe_ file created a subprocess called _more.com_ which executes from the SYSWOW64 folder in turn creating two subprocesses of _conhost.exe_ and _Launcher.exe_ executing from the AppData folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/process-tree-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/process-tree-setup-exe.png" img_alt="process tree set-up.exe" %}

We use x32Dbg for debugging the _Set-up.exe_ file. We set the following breakpoints which we got from the file activity in procmon.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/x32dbg-breakpoint-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/x32dbg-breakpoint-setup-exe.png" img_alt="x32dbg breakpoint set-up.exe" %}

We hit an interesting CreateFile breakpoint,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/pla.dll-createfile-breakpoint.jpeg" img_datasrc="../assets/img/analysis/lumma/pla.dll-createfile-breakpoint.png" img_alt="pla.dll createfile breakpoint" %}

It created a file called _pla.dll_ in the SYSWOW64 folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/pla.dll-created.jpeg" img_datasrc="../assets/img/analysis/lumma/pla.dll-created.png" img_alt="pla.dll created" %}

Simultaneously it also created the _Launcher.exe_ in the AppData folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/temp-folder-launcher-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/temp-folder-launcher-exe.png" img_alt="temp folder launcher.exe" %}

We hit another breakpoint of CreateProcess, it is creating a process of _IUservice_ from the roaming folder,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/roaming-folder.jpeg" img_datasrc="../assets/img/analysis/lumma/roaming-folder.png" img_alt="roaming folder" %}

Unfortunately, we do not see any executable in that folder, although it copied itself in that folder for **persistence**.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/roaming-folder-content.jpeg" img_datasrc="../assets/img/analysis/lumma/roaming-folder-content.png" img_alt="roaming folder content" %}

Another breakpoint of CreateProcess was hit, it is creating a process of _more.com_ from the SYSWOW64 folder,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/more.com-createprocess-breakpoint.jpeg" img_datasrc="../assets/img/analysis/lumma/more.com-createprocess-breakpoint.png" img_alt="more.com createprocess breakpoint" %}

We can also see _more.com_ in the SYSWOW64 folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/more.com-created.jpeg" img_datasrc="../assets/img/analysis/lumma/more.com-created.png" img_alt="more.com created" %}

In parallel we were also monitoring the network connections, The _Set-up.exe_ tried to communicate with the following URL,

~~~
hittybanndwk[.]shop
racedsuitreow[.]shop
defenddsouneuw[.]shop
deallyharvenw[.]shop
priooozekw[.]shop
pumpkinkwquo[.]shop
abortinoiwiam[.]shop
surroundeocw[.]shop
covvercilverow[.]shop
steamcommunity[.]com
~~~

### IOCs

1. IPs
	~~~
	165[.]227[.]121[.]41
	~~~
2. URLs
	~~~
	downcheck[.]nyc3[.]cdn[.]digitaloceanspaces[.]com
	hittybanndwk[.]shop
	racedsuitreow[.]shop
	defenddsouneuw[.]shop
	deallyharvenw[.]shop
	priooozekw[.]shop
	pumpkinkwquo[.]shop
	abortinoiwiam[.]shop
	surroundeocw[.]shop
	covvercilverow[.]shop
	steamcommunity[.]com
	~~~
3. Hashes
	~~~
	36a942a4e3308d47dfecbce2cd9c85ed316f877dbb85706f413cddcf04960a56
	36c0dba42123f1bda46e4526af9a6fe2ceca755470703a45e90d5c0515c0044c
	038511fc64801be03d8472a2f7a6ba8a27e0398cf876be1427c1463cf9190c80
	11e3568f497c40331ee4a9e9973967e61b224e19204e09ed7451da3b74bd2ff5
	fb64a5954b726d2d0f0bc26113a36dc8a86c469af994ceeaf2e2609743a0a557
	80ae800e8b3a8091249d7e8b25a81788a3fe1ab5ece122bf0bd7ac458bc2f315
	11d0f55c105883d203137a87a610ba793299dc4774fd6d8b3a86666a2c337041
	6b2174db9f76580e59ff9fa91247491ce3da49172afe415ff8deb2a3fc7b97dc
	d5a6714ab95caa92ef1a712465a44c1827122b971bdb28ffa33221e07651d6f7
	a65d00beae117d1421b28ec9e6fe03893586eb7c96cd2089644901088129e24f
	ccccadde7393f1b624cde32b38274e60bbe65b1769d614d129babdaeef9a6715
	d4e5b7223d06cd464df898c6cf569ca00743e5e79e64009056602b09927d9bfe
	95c8afbac49a7554453bfe509b11919a4e25742f292a11bac0ac467ec78b517a
	92a918a88da8b8413381acad73ac093162d5237eedb1ef41c7c5aa604d3206ed
	c3f6f6f1c310d0d61c2d07950fb2bd23d2b8a979e52d94cb623435aaed30ec60
	fe65540f70c1a4c7d9625f8dc8f81fc47bacd0ffb65cb4b147e20b27a7d5d709
	c2a583893795478556573db3a020ee607fabe7e37473d094d825f96c4912c43d
	118de01fb498e81eab4ade980a621af43b52265a9fcbae5dedc492cdf8889f35
	~~~