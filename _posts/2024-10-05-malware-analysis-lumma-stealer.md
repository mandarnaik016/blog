---
layout: post
title: Malware Analysis - Lumma Stealer
subtitle: Are You A Robot?
cover-img: /assets/img/analysis/analysis.webp
thumbnail-img: ""
tags: [analysis, security]
---
In this post, we will analyze malware and reverse engineer a sample called **lumma stealer**.

A web-based attack vector has a captcha page that asks the users to perform the task for verification.

The user is presented with a captcha page as shown below,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malicious-webpage.jpeg" img_datasrc="../assets/img/analysis/lumma/malicious-webpage.png" img_alt="malicious webpage" %}

On a legitimate page, the user will be asked to select some boxes that contain this or that object, but here the users are asked to run a PowerShell script for verification that is automatically copied to the system clipboard once the user clicks on "I am not a robot" as shown below,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malicious-webpage-action.jpeg" img_datasrc="../assets/img/analysis/lumma/malicious-webpage-action.png" img_alt="malicious webpage action" %}

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/powershell-execution-from-malicious-page.jpeg" img_datasrc="../assets/img/analysis/lumma/powershell-execution-from-malicious-page.png" img_alt="powershell execution from malicious page" %}

We will use the automatically copied PowerShell script for investigation, the script contains a base64 encoded text being executed with a hidden window.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/automatically-copied-powershell-script.jpeg" img_datasrc="../assets/img/analysis/lumma/automatically-copied-powershell-script.png" img_alt="automatically copied powershell script" %}

After decoding the base64 text we get the following data, The decoded text contains another PowerShell command to execute the content of a file called a.txt stored at a remote location.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/base64-decoded-powershell-script.jpeg" img_datasrc="../assets/img/analysis/lumma/base64-decoded-powershell-script.png" img_alt="base64 decoded powershell script" %}

We download the a.txt file for further examination.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/a-txt-file-downloaded.jpeg" img_datasrc="../assets/img/analysis/lumma/a-txt-file-downloaded.png" img_alt="a.txt file downloaded" %}

The a.txt contains,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/a-txt-file-content.jpeg" img_datasrc="../assets/img/analysis/lumma/a-txt-file-content.png" img_alt="a.txt file content" %}

The file in turn contains another PowerShell command that downloads the file called malt.zip from a remote location and stores that file with a different name pg1.zip in a temp location, it then extracts the pg1.zip content into the file folder then executes the set-up.exe from that path.

After unzipping malt.zip the directory content is,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/malt-zip-file-content.jpeg" img_datasrc="../assets/img/analysis/lumma/malt-zip-file-content.png" img_alt="malt.zip file content" %}

The interesting thing to note, the file set-up.exe has a resemblance to the Iobit uninstaller. A normal user would see the copyright of the file to be Iobit and might consider the file as Legitimate.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/properties-of-setup-exe-iobit.jpeg" img_datasrc="../assets/img/analysis/lumma/properties-of-setup-exe-iobit.png" img_alt="properties of set-up.exe iobit" %}

Apart from set-up.exe, we do not find any executable in the directory but after we check the file type of every file we can see that most of the files with bpl extension are executable.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/file-type-of-unzipped-malt-zip.jpeg" img_datasrc="../assets/img/analysis/lumma/file-type-of-unzipped-malt-zip.png" img_alt="file type of unzipped malt.zip" %}

We ran floss on madbasic_.bpl, maddisAsm_.bpl, madexcept_.bpl and Set-up.exe,

The strings inside madbasic_.bpl seems pretty interesting they include text like Encrypt, Decrypt, Encode, and Decode.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/madbasic_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/madbasic_.bpl-floss.png" img_alt="madbasic_.bpl floss" %}

The file maddisAsm_.bpl has a reference to the previous file madbasic_.bpl.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/maddisAsm_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/maddisAsm_.bpl-floss.png" img_alt="maddisAsm_.bpl floss" %}

The file madexcept_.bpl contains text like HTTP account, password, SMTP account, password, etc.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/madexcept_.bpl-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/madexcept_.bpl-floss.png" img_alt="madexcept_.bpl floss" %}

At last, the Set-up.exe contains text like sending mail, sending attachments, etc.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/set-up.exe-floss.jpeg" img_datasrc="../assets/img/analysis/lumma/set-up.exe-floss.png" img_alt="set-up.exe floss" %}

Let's do a dynamic analysis to get more insight.

After we execute the file we use procom to get the activity performed by set-up.exe file.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/process-monitor-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/process-monitor-setup-exe.png" img_alt="process monitor set-up.exe" %}

The file did perform a lot of activity but the most interesting are CreateFile, ReadFile, WriteFile, and CreateProcess.

The process tree gave us more insight i.e. the set-up.exe file created a subprocess called more.com which executes from the SYSWOW64 folder in turn creating two subprocesses of conhost.exe and Launcher.exe executing from the AppData folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/process-tree-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/process-tree-setup-exe.png" img_alt="process tree set-up.exe" %}

We use x32Dbg for debugging the set-up.exe file. We set the following breakpoints which we got from the file activity in procmon.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/x32dbg-breakpoint-setup-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/x32dbg-breakpoint-setup-exe.png" img_alt="x32dbg breakpoint set-up.exe" %}

We hit an interesting CreateFile breakpoint,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/pla.dll-createfile-breakpoint.jpeg" img_datasrc="../assets/img/analysis/lumma/pla.dll-createfile-breakpoint.png" img_alt="pla.dll createfile breakpoint" %}

It created a file called pla.dll in the SYSWOW64 folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/pla.dll-created.jpeg" img_datasrc="../assets/img/analysis/lumma/pla.dll-created.png" img_alt="pla.dll created" %}

Simultaneously it also created the Launcher.exe in the AppData folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/temp-folder-launcher-exe.jpeg" img_datasrc="../assets/img/analysis/lumma/temp-folder-launcher-exe.png" img_alt="temp folder launcher.exe" %}

We hit another breakpoint of CreateProcess, it is creating a process of IUservice from the roaming folder,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/roaming-folder.jpeg" img_datasrc="../assets/img/analysis/lumma/roaming-folder.png" img_alt="roaming folder" %}

Unfortunately, we do not see any executable in that folder, although it copied itself in that folder for persistence.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/roaming-folder-content.jpeg" img_datasrc="../assets/img/analysis/lumma/roaming-folder-content.png" img_alt="roaming folder content" %}

Another breakpoint of CreateProcess was hit, it is creating a process of more.com from the SYSWOW64 folder,

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/more.com-createprocess-breakpoint.jpeg" img_datasrc="../assets/img/analysis/lumma/more.com-createprocess-breakpoint.png" img_alt="more.com createprocess breakpoint" %}

We can also see more.com in the SYSWOW64 folder.

{% include lazyimg.html img_src="../assets/img/analysis/lumma/lowly/more.com-created.jpeg" img_datasrc="../assets/img/analysis/lumma/more.com-created.png" img_alt="more.com created" %}

In parallel we were also monitoring the network connections, The set-up.exe tried to communicate with the following URL,

~~~
hittybanndwk[.]shop
racedsuitreow[.]shop
defenddsouneuw[.]shop
deallyharvenw[.]shop
priooozekw[.]shop
pumpkinkwquo[.]shop
abortinoiwiam[.]shop
surroundeocw[.]shop
covvercilverow[.]shop
steamcommunity[.]com
~~~