---
layout: post
title: Malware Analysis - VIP Keylogger
subtitle: Comments Are Useful!!!
cover-img: /assets/img/analysis/analysis.jpeg
thumbnail-img: ""
tags: [analysis, security]
---

Hello, in this post, we will do malware analysis and reverse engineering of VIP Keylogger.

The file was downloaded from MalwareBazaar

The SHA256 hash of the file is as shown below,
```
d6255b39e2be431e6226c8414b75721a16c114960f8a87acc06ea9fa7563006f
```

The file is being flagged by 4 security vendors as malicious.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/vip-keylogger-virustotal-result.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/vip-keylogger-virustotal-result.png" img_alt="vip keylogger virustotal result" %}

The file opened in Notepad appears to be obfuscated.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/obfuscated-script-in-notepad.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/obfuscated-script-in-notepad.png" img_alt="obfuscated script in notepad" %}

The data present within `%%` can be replaced to create a meaningful batch command, i.e., the first line can be evaluated as `@echo off`.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/deobfuscated-first-line.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/deobfuscated-first-line.png" img_alt="deobfuscated first line" %}

We replaced the first few lines to deobfuscate,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/deobfuscated-few-lines.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/deobfuscated-few-lines.png" img_alt="deobfuscated few lines" %}

The deobfuscated lines above yield the current file's full path when executed,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/variable-returns-file-fullpath.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/variable-returns-file-fullpath.png" img_alt="variable returns file fullpath" %}

The preceding few lines execute the current batch file with a minimized window and also copy itself to the **user profile directory** with the name *aoc.bat*.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/execute-and-copy-to-user-profile-directory.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/execute-and-copy-to-user-profile-directory.png" img_alt="execute and copy to user profile directory" %}

All the next lines contain similar obfuscation,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/redudnant-data-between-percentage.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/redudnant-data-between-percentage.png" img_alt="redudnant data between percentage" %}

We can use the regex `%([a-z]{15}+)%` to replace the data to create meaningful statements within a batch script.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/regex-replace-unusable-code.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/regex-replace-unusable-code.png" img_alt="regex replace unusable code" %}

Once replaced, we can observe data being set to variables.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/data-after-regex-replace.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/data-after-regex-replace.png" img_alt="data after regex replace" %}

After the deobfuscation, we can see those variables being concatenated at a later point within the script.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/variables-concatenated-afterwards.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/variables-concatenated-afterwards.png" img_alt="variables concatenated afterwards" %}

{: .box-note}
**NOTE:** Don't replace the regex entirely within the file. Since the replacement will also remove the code where data is being concatenated, it will make the script unexecutable.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/issue-due-to-regex-replace.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/issue-due-to-regex-replace.png" img_alt="issue due to regex replace" %}

The concatenated string contains 229 variables for replacement. We use the previously deobfuscated data after regex replace to print the concatenated output to the console.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/echo-data-to-be-concatenated-batch-script.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/echo-data-to-be-concatenated-batch-script.png" img_alt="echo data to be concatenated batch script" %}

The data is,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/decoded-concatenated-data.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/decoded-concatenated-data.png" img_alt="decoded concatenated data" %}

Finally, we replace the remaining lines with the previously mentioned regular expression to produce the deobfuscated batch script.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/entire-deobfuscated-script.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/entire-deobfuscated-script.png" img_alt="entire deobfuscated script" %}

The console output of concatenated data from various variables, after being deobfuscated, results in another PowerShell command, as shown.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/concatenated-deobfuscated-powershell-command.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/concatenated-deobfuscated-powershell-command.png" img_alt="concatenated deobfuscated powershell command" %}

The PowerShell command contains a string that contains a replacement of *"ghobbwnmfz"*. We replace the following to get another string within the PowerShell command as

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/replaced-powershell-command.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/replaced-powershell-command.png" img_alt="replaced powershell command" %}

The formed string after replacement contains a base64 encoded string, which we decode using CyberChef.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/base64-decoded-powershell-command.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/base64-decoded-powershell-command.png" img_alt="base64 decoded powershell command" %}

The decoded string, in turn, contains another PowerShell script.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/embedded-powershell-script-beautified.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/embedded-powershell-script-beautified.png" img_alt="embedded powershell script beautified" %}

The script extracts data in parts that start with `:::[1-4]` from the initial batch script that copied itself to user profiles with the name aoc.bat

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/parts-extraction-from-initial-script.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/parts-extraction-from-initial-script.png" img_alt="parts extraction from initial script" %}

The following are the parts extracted.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/extracted-parts.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/extracted-parts.png" img_alt="extracted parts" %}

The extracted parts are being concatenated, replaced, and base64 decoded.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/parts-concatenated-replaced-decoded.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/parts-concatenated-replaced-decoded.png" img_alt="parts concatenated replaced decoded" %}

Equivalent output of the above operation using CyberChef,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/parts-concatenated-replaced-decoded-cyberchef.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/parts-concatenated-replaced-decoded-cyberchef.png" img_alt="parts concatenated replaced decoded cyberchef" %}

The output contains PowerShell script that contains functions, as shown below,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/powershell-functions.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/powershell-functions.png" img_alt="powershell functions" %}

In short, the functions perform the following operations,

| Function | Description |
| :------ |:--- |
| Initialize-FlowerGarden | Initializes the environment variables |
| Setup-FlowerPolicy | Sets the execution policy to bypass/unrestricted |
| Disable-FlowerLogging | Disables event logging |
| Setup-FlowerEnvironment | Disables/tweaks AMSI |
| Perform-FlowerMaintenance | Disables/tweaks AMSI |

Further, the variable *$orange* also contains base64 encoded data that is being decoded and uncompressed using gzip.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/orange-encoded-data.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/orange-encoded-data.png" img_alt="orange encoded data" %}

Cyberchef would help to decode this as follows,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/orange-decoded-data.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/orange-decoded-data.png" img_alt="orange decoded data" %}

Yet another PowerShell script is being shown as output.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/final-powershell-script.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/final-powershell-script.png" img_alt="final powershell script" %}

Unlike the last PowerShell script that extracted parts from the initial script containing `:::[1-4]`, this script extracts `:: ` from the initial script located in the user profile directory for performing further operations,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/final-powershell-script-data-extracted.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/final-powershell-script-data-extracted.png" img_alt="final powershell script data extracted" %}

The extracted data is being split with `\` to create an array containing two elements. Afterward, respective elements are base64 decoded. Then, it was decrypted using AES and uncompressed using gzip.

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/final-powershell-script-data-split-decoded.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/final-powershell-script-data-split-decoded.png" img_alt="final powershell script data split decoded" %}

The decoded output is,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/cyberchef-decoded-base64-final.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/cyberchef-decoded-base64-final.png" img_alt="cyberchef decoded base64 final" %}

The first part, after performing the previously mentioned operations, results in an executable file,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/first-exe.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/first-exe.png" img_alt="first exe" %}

The second part, after performing the previously mentioned operations, also results in an executable file,

{% include lazyimg.html img_src="../assets/img/analysis/vipkeylogger/lowly/second-exe.jpeg" img_datasrc="../assets/img/analysis/vipkeylogger/second-exe.png" img_alt="second exe" %}

Thank you for being up to here. We will continue the analysis in the next part for the executables uncovered.

![to be continued](../assets/img/analysis/to-be-continued.png)

### UPDATE:

2025-11-01: Added the second part of [VIP keylogger malware analysis](https://mandarnaik016.in/blog/2025-10-25-malware-analysis-vip-keylogger-part2/).
